<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAOGSURBVDhPJdJ9TNVVGMDxw+Wde3kRdAaasYFtWoQjnWGb4gAHm6CoTSWJtLRZKFlpN3IE4y0TVOLu8uKQeyUYhLw4UEQkr0HCeBsxSSMBB0hCtdC8jZj67UH+ODvP7+yczznP8/xUSlkbwatWsszLFR93BzYE+rDzQDRvpyYQZ/iKOPNpYi+Y2H3dQnzfEAdv/867faNsycvBf6kbam9WBSFLdNjYKXRKEfWqF4lHd/FxfgqflKRx5LtvSGwo4fDPPSSP3MMwPsnpv2c5+NsQgd5aVOArqwnxckEJsFzGntXepCfHk3E+i/Ti46SXp5Px0wXSJocxPvqLGquVstmnfH6jlvVuGpTO0YlVrjqUo2KRvGCdqw36qCAMBccwmJLIzT9E7qkEMs98QVbecXKqizD80sOhT7exSSuAjb0GPyfH50Ck9wLCX3Bl8yJb0mICKKn4ksKGk+Slx5IcvpK0t8IwtfXQBOzbG0uokw1KOWh4UzufQpCblsXOtrKoeF3G+ZoMOmVzUVs9Oz0VAbJ2OCwMQ+ZpPgwOYIONkheIErHY4znga2dLqP9Clkm8VjZX/VBEtwDm/layIvz4en8ENb29FDddQr/xJTbKPqV0Grxd5m8N1SoS31hKsMTvL1HU3u/i5tNZKv+dwmgpo7CzmnLrGDcErRtu5T1puVJudlJJW9zl0Acr3Ihf4cI6ibP3hVD+aJi+mcdceTiO+XYzpXctXPnzVx4+e8ITQaos1XOAPcrDjoVyaP+LzkS7KzZJbpXVJ2jAiuW/aWoH6vn+ZikXJ+/Qa50W4BkzAvRYpwRwnQc8BXjHS0OMAJESm08doLi+iEvN5VRWJHGx7iSNU2Pcsj7m7sw/jM5YaZ++L4BW8neXfjrIT+TlwNFwfyKlFvrQ5RibTRQ0mym8WkzpjxU0jN+j68EE3ROjDPzxgJaJYQFcpJI66afMc5Xf8rIbMX5aMnYHc9aYRI6liuyBDqoG+2kbHeH60B06Rga5NTZC4+CAAM4CzCFyq48Aa+R7m4c9H3nr0Psu4ExcFKnF2Rg7W6nqbqeiq526vk5a+vswdXYIIH+gcppHXKSvr0m8Vtp6ZH0QydGhpOr1JBiz+ezqZZKbGkiRkXmtkeyWaxy7XC+AvRyW/OcgW5n95AUBnhoi1/iyfUcIW5MS2Jx7gq3nCthuPsuu0nPsKTOzo9REWP63/A9LfT5MoLhg6gAAAABJRU5ErkJggg==">
  <title>Doc</title>
  <style>
#i{padding: 33px 0;background: linear-gradient(rgba(0,0,0,0.9), blue); 
text-align: center;
}

  </style>  
</head>
<body text=red>
<a href="file:///K:/!/projAll/html2/dig2.html">feb2023</a>
<a href="file:///K:/!/projAll/html1/main.html">dec2023</a>
<a href="file:///K:/!/projAll/css_%D0%BF%D1%81%D0%B5%D0%B2%D0%B4%D1%8B/index.html">два кота
(с iframes)
</a>

<h1><span id="da"></span><span>  . . . . .. .. . . . .. . .</span><span></span></h1>
<div id=i></div>
<script>
let s;
//**************
/*
s='<ulгц><liнда></ulгц><olй></olй>';
s=s.replace(/<ul([а-я]+)>/gi,'1$1');
s=s.replace(/<ol([а-я]+)>/gi,'1$1'); 
s=s.replace(/<li([а-я]+)>/gi,'2$1');
s=s.replace(/(<\/[^а-я]+?)([а-я]+)(>)/gi,' z$2 ');
da.innerText=s;
*/
//**********парные
/*
s='<pгц></pгц><divй></divй>';
s=s.replace(/(<[^\/а-я]+?)([а-я]+)(>)/gi,' a$2 ');
s=s.replace(/(<\/[^а-я]+?)([а-я]+)(>)/gi,' z$2 ');
da.innerText=s;
*/
//**********
/*
s='zдкжaдкж';
s=s.replace(/z([а-я]+)a([а-я]+)/gi,'z$1-a$2');//отступы меж башнями
da.innerText=s;
*/
//**********
/*
s='aбюzбю1ш2кzкzшaчzчbииbииbииbии';
s=s.replace(/z([а-я]+)2([а-я]+)/gi,'z$1-2$2');// 
s=s.replace(/z([а-я]+)1([а-я]+)/gi,'z$1-1$2');//
s=s.replace(/a([а-я]+)z([а-я]+)/gi,'3$1');//
s=s.replace(/(b[а-я]+)+/gi,'$1');//c лишками крышками//
da.innerText=s;
*/
//**********
/*
s='cяcяcяcяcяcяcяcяcяcя';
s=s.replace(/([cdefghijklmnopqrstuvwxy])([а-я]+)(\1\2)+/gi,'$1$2-$1$2');//32 audio сжать в один
da.innerText=s;
*/
//**********
/*
s='1ы2фь(cбю)zфьzы';
s=s.replace(/2([а-я]+)\(/g,'a$1(');
da.innerText=s;
*/
//***************
function ff(x){// сокращения -------------------------------------------------
/*
в эту трясину может засосать до переполнения стека.
выдача может быть периодическая бесконечная
это как с математической дробью
например 1/3 дает три в периоде (3) отследить легко
период (13) сложнее, если в периоде больше цифр то уж извините.
может следить чтобы, вложенное  было короче внешнего?
 алгоритм  найти минус и от него в обе стороны брать символы и плюсовать их к тестовой строке
 до тех пор пока левая часть не станет равна правой типа 'a(c)z-a(c)z'
при достижении этого все тестовая поддстрока заменяется на '(a(c)z)'
может мешаются ()? позаменить их на чтото нейтральное типа <>?
*/
lenx=x.length;// длина входящего сообщения

const cre=x=>{
	let r = /-+/ig;
	let t, a=[];
	while (t =r.exec(x))a.push(t.index); 
	return a  
	}  

let e,xe,xd,n,i,s3,s4;

let a=cre(x);  //a: array of integer;
for (let i=0; i<a.length; i++){//i
	n=a[i];
	e=''; d='';
	xe=0; xd=0;
	for (let j=1;j<=Math.min(a[i],x.length-a[i]); j++) {//j 
		n--;
		d=d+x[a[i]+j];// правая часть тест-строки
		e=x[a[i]-j]+e;//  левая часть тест-строки
		switch(x[a[i]-j]){
			case 'z': {xe++; break}
			case 'a':
			case '1':
			case '2': {xe--; break}
		   }   
		switch(x[a[i]+j]){
			case 'a':
			case '1':
			case '2': {xd++; break}
			case 'z': {xd--; break}			
			}

		if ((xe<0)||(xd<0)) break;	  
		if ((xe===xd)&&(xd===0)&&(e===d)) {	  
		
		s3=x.substring(0,n); //  от индекса a до индекса b 
		s4=x.substring(n); // от n до конца
		let r=new RegExp("("+e+")(-\\1)+",'g');
		//let s="aadz-aaezfzz-aadz-aaezfzz-aadz-aaezfzz-aadz-aaezfzz-aadz-aaezfzzz-a(agz)zhzz";
		//s=s.replace(/(aadz-aaezfzz)(-\1)+/gi,'($1)');
		s4=s4.replace(r,'($1)');
		
		if(s4.length<lenx)
			{return s3 + ff(s4)}else{return s3+s4}
		}
	}//j
}//i
return x;
}//func ff	


//**********
let o={'a':'ф','b':'б','c':'в','d':'г','e':'д','f':'е','g':'ж','h':'з','i':'и','j':'к','k':'л','l':'м','m':'н','n':'п','o':'р','p':'с','q':'т','r':'у','s':'х','t':'ц','u':'ч','v':'ш','w':'щ','x':'э','y':'ю','z':'я','_':''}
let o2={'ф':'a','б':'b','в':'c','г':'d','д':'e','е':'f','ж':'g','з':'h','и':'i','к':'j','л':'k','м':'l','н':'m','п':'n','р':'o','с':'p','т':'q','у':'r','х':'s','ц':'t','ч':'u','ш':'v','щ':'w','э':'x','ю':'y','я':'z'}
const r=(x)=>[...x].map((i,j)=>o[i]).join('');
let never='!';
let alf="abcdefghijklmnopqrstuvwxyz";
let sp=['li'],sp2=['b'];
let a=['img','input','svg','param','unit','library_controllers','library_images','instance_geometry','instance_visual_scene'];
let re1=new RegExp('<([^>]+)><\/\1>|'+a.map(i=>'<'+i+'[а-я]+>').join('|'),'i');
let re2=new RegExp('<([^>]+)><\/\1>|'+a.map(i=>'<('+i+'[а-я]+)>').join('|'),'i');

//alert(re1);
const f=(mat,x1,x2)=>{
	if(!(sp.indexOf(x1)+1)){sp.push(x1); sp2.push(alf[sp.length])};

	return ' !'+sp2[sp.indexOf(x1)]+x2+'! ';
};
//s='<divци><unitяв></divци><divци></divци>'; 
//s='<div><unit></div><div><instance_geometry/></div>';//концентрат
s='<polylist><input/><input/><input/><vcount></vcount><p></p></polylist>';
s=s.replace(/\/>/g,'>'); 
ad=s.split(/([<>\/])/);
console.log(ad);
ad=ad.map(x=>{if(/[_a-z]/.test(x)){return x+r(x)}else{return x}}).join('');
console.log(ad);
s=ad;// ярлыками снабдил
s=s.replace(/<([^>а-я]+)([а-я]+)><\/\1\2>/ig,f);
// одинарные
while((re1).test(s)){
	let g=s.match(re2);
	let aw=g.filter((x,i)=>i&&x);
	g=aw[0];

	let u=g.replace(/[а-я]/gi,'');
	//alert(g+'='+u);
	let re3=new RegExp('<('+u+')([а-я]+)>','ig');
	s=s.replace(re3,f);
}
// списки
s=s.replace(/<ul([а-я]+)>/gi,'1$1');
s=s.replace(/<ol([а-я]+)>/gi,'1$1'); 
s=s.replace(/<li([а-я]+)>/gi,'2$1');
// парные
s=s.replace(/(<[^\/а-я]+?)([а-я]+)(>)/gi,' a$2 ');
s=s.replace(/(<\/[^а-я]+?)([а-я]+)(>)/gi,' z$2 ');
// антипробел
s=s.replace(/[<> ]/gi,'');
// убрал невер
let rg=new RegExp(never,'g');s=s.replace(rg,'');
//
s=s.replace(/z([а-я]+)a([а-я]+)/gi,'z$1-a$2');//отступы меж башнями
s=s.replace(/z([а-я]+)2([а-я]+)/gi,'z$1-2$2');// 
s=s.replace(/z([а-я]+)1([а-я]+)/gi,'z$1-1$2');//
s=s.replace(/a([а-я]+)z([а-я]+)/gi,'3$1');//
s=s.replace(/(b[а-я]+)+/gi,'$1');//c лишками крышками//
//
s=s.replace(/([cdefghijklmnopqrstuvwxy])([а-я]+)(\1\2)+/gi,'$1$2-$1$2');//32 audio сжать в один
//
mc=s.match(/(2[^-\r\n]+)/gi);// разбираюсь с лишками
if (!!mc) mc.forEach(x=>{let y=new RegExp(x+'-'+x,'g');s=s.replace(y,x)});
//


let sed;
do{
	sed=[...s].map(i=>i).join('');
	s=[...s].map(x=>(x===')')?'>':x).join('');
	s=[...s].map(x=>(x==='(')?'<':x).join('');
	s=ff(s);// сокращения ------------------------------------------------------------------
	s=[...s].map(x=>(x==='>')?')':x).join('');
	s=[...s].map(x=>(x==='<')?'(':x).join('');
	}while(sed!==s);//выход если обработка не изменила строку
//
s=s.replace(/2([а-я]+)\(/g,'a$1(');
//
const oba=(x)=>{
   //alert(x); //
	let s,k;
	let m=[];
	let a=[...x];
	a.forEach((i,j)=>{
		switch (i)// a(c)dz    a(c)(3)z
			{
			case 'a': m.push(j);break;
			case 'z': k=m.pop();//alert(m,k,a.join(''));
				let y=x.substring(k+2,j-1);
				// опознание по наличию скобок в содержимом
				// скобок нет - постамент не нужен
				if ((y.indexOf('(')>-1)||(y.indexOf(')')>-1)||
				((a[k+1]!=='(')||(a[j-1]!==')')))
				//if((a[k+1]!=='(')||(a[j-1]!==')'))
				{
				
				a[k]='A';
				a[j]='Z';
				}
			}//switch
		});
	s=a.join('');	
	s=s.replace(/a\(/g,'(');// попробую так 4.4.23...лихо 3.5.23
	s=s.replace(/\)z/g,')');
	s=s.toLowerCase();
	return s;
	}


s=oba(s);// устранение только парных скобок 4.5.23

let tv=s.split(/([a-z_][а-я]+)/);
let tv1=tv.map(i=>i.replace(/[а-я]/gi,'')).filter(i=>i);
let tv2=tv.map(i=>i.replace(/[a-z]/gi,'')).filter(i=>i);
tv2=tv2.map(i=>[...i].map(j=>o2[j]).join(''));
s=s.replace(/([а-я]+)/gi,'');
console.log(tv1);
console.log(tv2);

console.log(sp);
da.innerText=s;


</script>   
</body>
</html>